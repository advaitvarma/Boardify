<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event - Boardify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        'astra-blue': '#4F46E5', // Indigo-600 used for main blue
                        'astra-purple': '#9333ea', // Violet-600
                        'astra-pink': '#ec4899', // Pink-500
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'scale-in': 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'gradient-xy': 'gradient-xy 15s ease infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        'gradient-xy': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center'
                            }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Import custom font */
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; }
        /* Custom scrollbar for overflow areas */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #475569; }
        .wizard-step { animation-name: fadeIn; }
        /* Gradient for text/buttons */
        .text-gradient { background-image: linear-gradient(to right, #4F46E5, #9333ea); -webkit-background-clip: text; color: transparent; }
        
        /* Floating shapes for dynamic background */
        .bg-shape {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.6;
        }
    </style>
</head>
<!-- UPDATED: Dynamic Background Animation & Dark Mode Fix -->
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 transition-colors duration-500 min-h-screen flex flex-col bg-[length:400%_400%] animate-gradient-xy" id="create-page">

    <!-- Decorative background elements -->
    <div class="bg-shape bg-blue-200/40 dark:bg-indigo-900/20 w-96 h-96 top-0 left-0 animate-pulse-slow"></div>
    <div class="bg-shape bg-pink-200/40 dark:bg-purple-900/20 w-80 h-80 bottom-0 right-0 animate-pulse-slow delay-1000"></div>

    <!-- HEADER/LOGO -->
    <header class="w-full px-6 py-4 flex justify-between items-center z-10 backdrop-blur-sm bg-white/30 dark:bg-slate-900/30 sticky top-0">
        <div class="flex items-center cursor-pointer hover:opacity-80 transition">
            <!-- Logo matching the uploaded image -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2z" fill="url(#astrascore_gradient)"/>
                <path d="M12 4C7.582 4 4 7.582 4 12s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zm0 12l-4-4 4-4 4 4-4 4z" fill="#fff"/>
                <defs>
                    <linearGradient id="astrascore_gradient" x1="2" y1="2" x2="22" y2="22" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#4F46E5"/>
                        <stop offset="1" stop-color="#9333ea"/>
                    </linearGradient>
                </defs>
            </svg>
            <span class="ml-2 text-xl font-black text-astra-blue dark:text-white tracking-tight">AstraScore</span>
        </div>
        <!-- UPDATED: Toggle on documentElement for proper dark mode -->
        <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
            <i class="fas fa-moon text-slate-500 dark:text-slate-300 hover:text-astra-blue transition text-lg"></i>
        </button>
    </header>

    <!-- Progress Bar (Subtle & Gradient) -->
    <div class="w-full h-1 bg-blue-100 dark:bg-slate-800/50 relative overflow-hidden">
        <div class="h-full bg-red-500 w-1/4 transition-all duration-500 shadow-md shadow-red-500/50" id="progress-bar"></div>
    </div>

    <div class="container mx-auto px-4 sm:px-6 py-8 flex-grow max-w-4xl z-10 relative">
        <!-- Stepper (Visual Enhancement) -->
        <div class="flex justify-center gap-4 mb-8" id="stepper-container">
            <div id="dot-1" class="stepper-dot w-3 h-3 rounded-full bg-astra-blue transition-all duration-300 shadow-md transform scale-125"></div>
            <div id="dot-2" class="stepper-dot w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-700 transition-all duration-300"></div>
            <div id="dot-3" class="stepper-dot w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-700 transition-all duration-300"></div>
            <div id="dot-4" class="stepper-dot w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-700 transition-all duration-300"></div>
            <div id="dot-5" class="stepper-dot w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-700 transition-all duration-300"></div>
            <div id="dot-6" class="stepper-dot w-3 h-3 rounded-full bg-slate-300 dark:bg-slate-700 transition-all duration-300"></div>
        </div>

        <!-- Main Card (Softer, Modern Look) -->
        <div class="bg-white/90 backdrop-blur-md dark:bg-slate-800/90 rounded-3xl shadow-xl shadow-blue-100/50 dark:shadow-slate-900/50 p-6 md:p-10 relative overflow-hidden min-h-[600px] border border-white/50 dark:border-slate-700/50">
            <div id="top-gradient" class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-astra-blue via-astra-purple to-astra-pink transition-all duration-500"></div>

            <!-- Mode Switch (Gradiented Active State) -->
            <div class="flex justify-center mb-10">
                <div class="bg-slate-100 dark:bg-slate-900/50 p-1 rounded-full shadow-inner inline-flex gap-1 border border-slate-200 dark:border-slate-700">
                    <button onclick="switchMode('single')" id="btn-mode-single" class="px-6 py-3 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-astra-blue to-astra-purple text-white shadow-lg shadow-blue-400/50 hover:opacity-90 active:scale-95">
                        <i class="fas fa-gamepad mr-2"></i>Single Scoreboard
                    </button>
                    <button onclick="switchMode('festival')" id="btn-mode-fest" class="px-6 py-3 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-blue dark:text-slate-400 hover:bg-white dark:hover:bg-slate-700 active:scale-95">
                        <i class="fas fa-icons mr-2"></i>Festival / Mega Event
                    </button>
                </div>
            </div>

            <!-- Single Mode Flow -->
            <div id="single-mode-flow">

                <!-- Step 1: Category -->
                <div id="step-1" class="wizard-step animate-scale-in">
                    <h2 class="text-4xl font-black text-blue-900 dark:text-white mb-8 text-center">What's the <span class="text-gradient">game</span>?</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Card Enhancements: better hover, ring color update -->
                        <div class="cat-card cursor-pointer p-6 rounded-2xl bg-orange-50 dark:bg-slate-700 text-center hover:scale-[1.02] transition border-2 border-transparent hover:border-orange-400 hover:shadow-xl hover:shadow-orange-500/20 active:ring-4 active:ring-orange-200" onclick="selectCategory('sports', this)">
                            <i class="fas fa-trophy text-5xl text-orange-500 mb-4"></i>
                            <h3 class="font-black text-xl text-blue-900 dark:text-white">Sports</h3>
                        </div>
                        <div class="cat-card cursor-pointer p-6 rounded-2xl bg-blue-50 dark:bg-slate-700 text-center hover:scale-[1.02] transition border-2 border-transparent hover:border-astra-blue hover:shadow-xl hover:shadow-astra-blue/20 active:ring-4 active:ring-blue-200" onclick="selectCategory('academic', this)">
                            <i class="fas fa-graduation-cap text-5xl text-astra-blue mb-4"></i>
                            <h3 class="font-black text-xl text-blue-900 dark:text-white">Academic</h3>
                        </div>
                        <div class="cat-card cursor-pointer p-6 rounded-2xl bg-pink-50 dark:bg-slate-700 text-center hover:scale-[1.02] transition border-2 border-transparent hover:border-pink-400 hover:shadow-xl hover:shadow-pink-500/20 active:ring-4 active:ring-pink-200" onclick="selectCategory('cultural', this)">
                            <i class="fas fa-theater-masks text-5xl text-pink-500 mb-4"></i>
                            <h3 class="font-black text-xl text-blue-900 dark:text-white">Cultural</h3>
                        </div>
                        <div class="cat-card cursor-pointer p-6 rounded-2xl bg-purple-50 dark:bg-slate-700 text-center hover:scale-[1.02] transition border-2 border-transparent hover:border-astra-purple hover:shadow-xl hover:shadow-purple-500/20 active:ring-4 active:ring-purple-200" onclick="selectCategory('esports', this)">
                            <i class="fas fa-headset text-5xl text-astra-purple mb-4"></i>
                            <h3 class="font-black text-xl text-blue-900 dark:text-white">Esports</h3>
                        </div>
                    </div>
                    <div class="mt-10 text-right">
                        <!-- Updated CTA button with matching gradient -->
                        <button onclick="nextStep(2)" class="next-btn bg-gradient-to-r from-astra-blue to-astra-purple text-white px-10 py-4 rounded-xl font-black text-lg transition shadow-lg shadow-astra-blue/30 hover:shadow-xl hover:shadow-astra-purple/40 transform hover:-translate-y-0.5 active:scale-[0.98]">Next <i class="fas fa-arrow-right ml-2"></i></button>
                    </div>
                </div>

                <!-- Step 5: Board Selection (Moved in code, remains logical step 5) -->
                <div id="step-layout-board-select" class="wizard-step hidden animate-scale-in">
                    <div class="flex justify-center mb-4">
                        <span id="category-badge-final" class="bg-blue-100 text-astra-blue px-4 py-1 rounded-full text-xs font-black uppercase tracking-wide shadow-md">Category: Selected</span>
                    </div>
                    <h2 class="text-3xl font-black text-blue-900 dark:text-white mb-2 text-center">Choose your board <span class="text-gradient">type(s)</span></h2>
                    <p class="text-center text-slate-500 dark:text-slate-400 text-sm font-bold mb-8">Select all that apply. (Final Setup Step)</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <!-- Board Card Style Enhancement: Stronger border on select -->
                        <div class="board-type-card cursor-pointer p-4 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:shadow-lg hover:border-astra-blue transition relative group active:scale-[0.98]" onclick="toggleBoardType('leaderboard', this)">
                            <div class="absolute top-3 right-3 opacity-0 check-icon text-green-500 transition-all duration-300"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="h-16 bg-slate-100 dark:bg-slate-600 rounded-lg mb-3 flex flex-col justify-center gap-1 p-2 opacity-70 group-hover:opacity-100 transition-opacity">
                                <div class="h-2 w-3/4 bg-slate-300 dark:bg-slate-500 rounded"></div>
                                <div class="h-2 w-full bg-slate-300 dark:bg-slate-500 rounded"></div>
                                <div class="h-2 w-5/6 bg-slate-300 dark:bg-slate-500 rounded"></div>
                            </div>
                            <h3 class="font-black text-blue-900 dark:text-white">Leaderboard</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">Participants ranked in rows by score.</p>
                            <div class="rec-tag hidden mt-2 inline-block bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Recommended</div>
                        </div>

                        <div class="board-type-card cursor-pointer p-4 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:shadow-lg hover:border-astra-blue transition relative group active:scale-[0.98]" onclick="toggleBoardType('scoresheet', this)">
                            <div class="absolute top-3 right-3 opacity-0 check-icon text-green-500 transition-all duration-300"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="h-16 bg-slate-100 dark:bg-slate-600 rounded-lg mb-3 grid grid-cols-3 gap-1 p-2 opacity-70 group-hover:opacity-100 transition-opacity">
                                <div class="bg-slate-300 dark:bg-slate-500 rounded"></div><div class="bg-slate-300 dark:bg-slate-500 rounded"></div><div class="bg-slate-300 dark:bg-slate-500 rounded"></div>
                                <div class="bg-slate-300 dark:bg-slate-500 rounded"></div><div class="bg-slate-300 dark:bg-slate-500 rounded"></div><div class="bg-slate-300 dark:bg-slate-500 rounded"></div>
                            </div>
                            <h3 class="font-black text-blue-900 dark:text-white">Scoresheet</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">Multi-column grid for rounds & judges.</p>
                            <div class="rec-tag hidden mt-2 inline-block bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Recommended</div>
                        </div>

                        <div class="board-type-card cursor-pointer p-4 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:shadow-lg hover:border-astra-blue transition relative group active:scale-[0.98]" onclick="toggleBoardType('scoreboard', this)">
                            <div class="absolute top-3 right-3 opacity-0 check-icon text-green-500 transition-all duration-300"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="h-16 bg-slate-100 dark:bg-slate-600 rounded-lg mb-3 flex justify-center items-center gap-2 p-2 opacity-70 group-hover:opacity-100 transition-opacity">
                                <div class="w-8 h-8 bg-slate-300 dark:bg-slate-500 rounded-full"></div>
                                <div class="w-8 h-8 bg-slate-300 dark:bg-slate-500 rounded-full"></div>
                                <div class="w-8 h-8 bg-slate-300 dark:bg-slate-500 rounded-full"></div>
                            </div>
                            <h3 class="font-black text-blue-900 dark:text-white">Scoreboard</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">Large display blocks for participants.</p>
                            <div class="rec-tag hidden mt-2 inline-block bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Recommended</div>
                        </div>

                        <div class="board-type-card cursor-pointer p-4 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:shadow-lg hover:border-astra-blue transition relative group active:scale-[0.98]" onclick="toggleBoardType('sports-scoreboard', this)">
                            <div class="absolute top-3 right-3 opacity-0 check-icon text-green-500 transition-all duration-300"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="h-16 bg-slate-100 dark:bg-slate-600 rounded-lg mb-3 flex items-center justify-between px-4 opacity-70 group-hover:opacity-100 transition-opacity">
                                <div class="text-xs font-bold text-slate-400 bg-slate-300 dark:bg-slate-500 px-3 py-1 rounded">0</div>
                                <div class="text-[10px] font-bold bg-astra-purple text-white px-2 py-0.5 rounded-full">10:00</div>
                                <div class="text-xs font-bold text-slate-400 bg-slate-300 dark:bg-slate-500 px-3 py-1 rounded">0</div>
                            </div>
                            <h3 class="font-black text-blue-900 dark:text-white">Sports Board</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">Head-to-head scorebug with timer.</p>
                            <div class="rec-tag hidden mt-2 inline-block bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Recommended</div>
                        </div>

                        <div class="board-type-card cursor-pointer p-4 rounded-xl bg-white dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 hover:shadow-lg hover:border-astra-blue transition relative group active:scale-[0.98]" onclick="toggleBoardType('counter', this)">
                            <div class="absolute top-3 right-3 opacity-0 check-icon text-green-500 transition-all duration-300"><i class="fas fa-check-circle text-xl"></i></div>
                            <div class="h-16 bg-slate-100 dark:bg-slate-600 rounded-lg mb-3 flex justify-center items-center opacity-70 group-hover:opacity-100 transition-opacity">
                                <div class="w-10 h-10 rounded-full bg-astra-blue dark:bg-slate-500 flex items-center justify-center text-white font-bold text-2xl shadow-lg">+</div>
                            </div>
                            <h3 class="font-black text-blue-900 dark:text-white">Counter</h3>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1 font-medium">Simple click counter/tally.</p>
                            <div class="rec-tag hidden mt-2 inline-block bg-green-100 text-green-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase">Recommended</div>
                        </div>
                    </div>

                    <div id="board-error-final" class="hidden text-center text-red-500 text-sm font-bold mb-4 animate-pulse">
                        <i class="fas fa-exclamation-circle mr-1"></i> Please choose at least one board type.
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="prevStep(4)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="validateBoardStepFinal()" class="bg-gradient-to-r from-astra-blue to-astra-purple text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-astra-purple/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next: Review</button>
                    </div>
                </div>

                <!-- Step 2: Participants -->
                <div id="step-2" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-blue-900 dark:text-white mb-6 text-center">Who's <span class="text-gradient">playing</span>?</h2>

                    <div class="flex justify-center mb-8">
                        <!-- Participant Type Switch Style Enhancement -->
                        <div class="bg-slate-100 dark:bg-slate-700/50 p-1 rounded-full inline-flex border border-slate-200 dark:border-slate-700 shadow-inner">
                            <button onclick="setParticipantType('teams')" id="pt-teams" class="px-6 py-2 rounded-full font-bold text-sm transition-all bg-white text-astra-blue shadow-md dark:bg-slate-800 dark:text-white">Teams</button>
                            <button onclick="setParticipantType('individuals')" id="pt-individuals" class="px-6 py-2 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-blue dark:hover:text-white">Individuals</button>
                            <button onclick="setParticipantType('houses')" id="pt-houses" class="px-6 py-2 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-blue dark:hover:text-white">Houses</button>
                        </div>
                    </div>

                    <!-- Entity Management Section -->
                    <div id="individual-entities-section" class="mb-8 hidden">
                        <div class="bg-blue-50/50 dark:bg-slate-700/50 p-6 rounded-2xl border border-blue-100 dark:border-slate-700 shadow-inner">
                            <h3 class="font-black text-xl text-astra-blue dark:text-white mb-4 flex items-center">
                                <i class="fas fa-school text-astra-blue mr-2"></i> Manage Schools / Houses / Teams <span class="text-xs text-slate-400 font-medium ml-2">(Optional)</span>
                            </h3>
                            <div id="single-entities-list" class="space-y-3 max-h-48 overflow-y-auto mb-4 p-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800">
                                </div>
                            <!-- Button style matching new gradient action style -->
                            <button onclick="openSingleEntityModal()" class="w-full py-2 bg-gradient-to-r from-blue-100 to-blue-200 text-astra-blue rounded-xl text-sm font-bold hover:from-blue-200 transition active:scale-[0.99] shadow-md">
                                <i class="fas fa-plus-circle mr-1"></i> Add Entity
                            </button>
                        </div>
                    </div>

                    <div class="mb-8 text-center">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-2" id="count-label">How many teams?</label>
                        <div class="flex justify-center gap-2 mb-4">
                            <button onclick="generateParticipants(2)" class="px-4 py-2 bg-blue-50 dark:bg-slate-600 text-astra-blue dark:text-blue-200 rounded-lg font-bold hover:bg-blue-100 transition active:scale-[0.95]">2</button>
                            <button onclick="generateParticipants(4)" class="px-4 py-2 bg-blue-50 dark:bg-slate-600 text-astra-blue dark:text-blue-200 rounded-lg font-bold hover:bg-blue-100 transition active:scale-[0.95]">4</button>
                            <button onclick="generateParticipants(6)" class="px-4 py-2 bg-blue-50 dark:bg-slate-600 text-astra-blue dark:text-blue-200 rounded-lg font-bold hover:bg-blue-100 transition active:scale-[0.95]">6</button>
                            <button onclick="generateParticipants(8)" class="px-4 py-2 bg-blue-50 dark:bg-slate-600 text-astra-blue dark:text-blue-200 rounded-lg font-bold hover:bg-blue-100 transition active:scale-[0.95]">8</button>
                        </div>
                    </div>

                    <div id="participants-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[300px] overflow-y-auto pr-2 mb-6 scrollbar-thin">
                        </div>

                    <div class="text-center mb-8">
                        <button onclick="addParticipant()" class="text-sm font-bold text-astra-purple hover:text-astra-blue transition active:scale-[0.98]"><i class="fas fa-plus-circle mr-1"></i> Add Participant</button>
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="prevStep(1)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="nextStep(3)" class="bg-gradient-to-r from-astra-blue to-astra-purple text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-astra-purple/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next</button>
                    </div>
                </div>

                <!-- Step 3: Scoring -->
                <div id="step-3" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-blue-900 dark:text-white mb-2 text-center">How do we <span class="text-gradient">score</span> it?</h2>
                    <p id="scoring-subtitle" class="text-center text-slate-500 dark:text-slate-400 text-sm font-bold mb-8 uppercase tracking-wide">Game Type: Sports</p>

                    <div class="grid grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Score Unit Name</label>
                            <input type="text" id="score-unit" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent dark:text-white font-bold text-slate-700 focus:ring-2 focus:ring-astra-blue transition" placeholder="e.g. Points">
                        </div>
                        <div class="flex items-center">
                            <label class="flex items-center cursor-pointer mt-5">
                                <input type="checkbox" id="allow-negative" class="w-5 h-5 rounded text-astra-blue focus:ring-astra-blue border-gray-300 accent-astra-blue">
                                <span class="ml-2 text-sm font-bold text-slate-600 dark:text-slate-300">Allow Negative Scores?</span>
                            </label>
                        </div>
                    </div>

                    <div id="panel-sports" class="cat-panel hidden space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Sport Type</label>
                            <select id="sport-type" onchange="updateSportFields()" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-astra-blue transition">
                                <option value="football">Football</option>
                                <option value="cricket">Cricket</option>
                                <option value="basketball">Basketball</option>
                                <option value="volleyball">Volleyball</option>
                                <option value="custom">Custom Sport</option>
                            </select>
                        </div>
                        <div id="sport-specific-options" class="bg-orange-50/50 dark:bg-slate-700/50 p-4 rounded-xl border border-orange-100 dark:border-slate-700">
                            </div>
                    </div>

                    <div id="panel-academic" class="cat-panel hidden space-y-6">
                        <div class="flex gap-4">
                            <label class="cursor-pointer"><input type="radio" name="acad-type" value="quiz" checked onchange="updateAcadFields()" class="accent-astra-blue"> <span class="font-bold text-slate-600 dark:text-slate-300">Quiz</span></label>
                            <label class="cursor-pointer"><input type="radio" name="acad-type" value="debate" onchange="updateAcadFields()" class="accent-astra-blue"> <span class="font-bold text-slate-600 dark:text-slate-300">Debate</span></label>
                            <label class="cursor-pointer"><input type="radio" name="acad-type" value="other" onchange="updateAcadFields()" class="accent-astra-blue"> <span class="font-bold text-slate-600 dark:text-slate-300">Other</span></label>
                        </div>
                        <div id="acad-specific-options" class="bg-blue-50/50 dark:bg-slate-700/50 p-4 rounded-xl border border-blue-100 dark:border-slate-700">
                             </div>
                    </div>

                    <div id="panel-cultural" class="cat-panel hidden space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Event Sub-Type</label>
                            <select class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-pink-500 transition">
                                <option>Dance</option>
                                <option>Music / Singing</option>
                                <option>Drama</option>
                                <option>Fashion Show</option>
                            </select>
                        </div>
                        <div class="flex gap-6">
                             <label class="flex items-center gap-2"><input type="radio" name="cult-perf" value="solo" class="accent-pink-500" checked> <span class="font-bold text-sm dark:text-white">Solo</span></label>
                             <label class="flex items-center gap-2"><input type="radio" name="cult-perf" value="group" class="accent-pink-500"> <span class="font-bold text-sm dark:text-white">Group</span></label>
                        </div>
                        <div class="bg-pink-50/50 dark:bg-slate-700/50 p-4 rounded-xl border border-pink-100 dark:border-slate-700">
                            <h4 class="font-bold text-pink-600 mb-2 text-sm">Judging Criteria</h4>
                            <table class="w-full text-sm" id="criteria-table">
                                <thead><tr class="text-left text-slate-400 text-xs uppercase"><th>Criteria Name</th><th class="w-20">Max</th><th></th></tr></thead>
                                <tbody id="criteria-body"></tbody>
                            </table>
                            <button onclick="addCriteriaRow()" class="mt-2 text-xs font-bold text-pink-500 hover:text-pink-700 transition active:scale-[0.98]">+ Add Criteria</button>
                        </div>
                    </div>

                    <div id="panel-esports" class="cat-panel hidden space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Game Title</label>
                            <select class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent font-bold text-slate-700 dark:text-white focus:ring-2 focus:ring-astra-purple transition">
                                <option>Valorant / CS2 (FPS)</option>
                                <option>BGMI / Warzone (Battle Royale)</option>
                                <option>FIFA / Rocket League</option>
                                <option>MOBA (Dota/LoL)</option>
                            </select>
                        </div>
                         <div class="bg-purple-50/50 dark:bg-slate-700/50 p-4 rounded-xl border border-purple-100 dark:border-slate-700">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Series Type</label>
                            <div class="flex gap-4 mb-4">
                                <label class="cursor-pointer font-bold text-sm text-slate-600 dark:text-slate-300"><input type="radio" name="series" value="bo1" class="accent-astra-purple"> BO1</label>
                                <label class="cursor-pointer font-bold text-sm text-slate-600 dark:text-slate-300"><input type="radio" name="series" value="bo3" class="accent-astra-purple" checked> BO3</label>
                                <label class="cursor-pointer font-bold text-sm text-slate-600 dark:text-slate-300"><input type="radio" name="series" value="bo5" class="accent-astra-purple"> BO5</label>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700 mt-6">
                        <button onclick="prevStep(2)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="nextStep(4)" class="bg-gradient-to-r from-astra-blue to-astra-purple text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-astra-purple/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next</button>
                    </div>
                </div>

                <!-- Step 4: Layout & Setup -->
                <div id="step-4" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-blue-900 dark:text-white mb-6 text-center">Layout & <span class="text-gradient">Setup</span></h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="space-y-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Scoreboard Name</label>
                                <input type="text" id="layout-name" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-transparent font-bold text-lg text-blue-900 dark:text-white focus:ring-2 focus:ring-astra-blue transition" placeholder="e.g. Summer Cup Finals">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Visual Theme</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-3 rounded-xl border-2 border-astra-blue bg-white dark:bg-slate-800 cursor-pointer text-center font-bold text-sm dark:text-white shadow-md">Light Mode</div>
                                    <div class="p-3 rounded-xl border-2 border-slate-200 dark:border-slate-600 bg-slate-900 text-white cursor-pointer text-center font-bold text-sm opacity-60 hover:opacity-80 transition">Dark Mode</div>
                                </div>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Display Options</label>
                                <div class="space-y-2">
                                    <label class="flex items-center cursor-pointer"><input type="checkbox" class="w-4 h-4 rounded text-astra-blue accent-astra-blue" checked> <span class="ml-2 text-sm font-medium dark:text-slate-300">Show Timer</span></label>
                                    <label class="flex items-center cursor-pointer"><input type="checkbox" class="w-4 h-4 rounded text-astra-blue accent-astra-blue"> <span class="ml-2 text-sm font-medium dark:text-slate-300">Show Logos</span></label>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50/50 dark:bg-slate-700/30 rounded-2xl p-5 border border-blue-100 dark:border-slate-600 shadow-inner">
                             <h3 class="text-sm font-black text-astra-blue dark:text-blue-300 uppercase mb-4"><i class="fas fa-sliders-h mr-2"></i> Custom Fields</h3>

                             <div class="mb-4">
                                <h4 class="text-xs font-bold text-slate-400 mb-2">Extra Stats (Rows)</h4>
                                <div id="single-rows-container" class="space-y-2 mb-2"></div>
                                <button onclick="addCustomRow('single-rows-container')" class="w-full py-2 border-2 border-dashed border-astra-blue/50 dark:border-slate-500 rounded-lg text-xs font-bold text-astra-blue hover:bg-blue-50/50 dark:hover:bg-slate-700 transition active:scale-[0.99]">+ Add Row</button>
                             </div>

                             <div>
                                <h4 class="text-xs font-bold text-slate-400 mb-2">Extra Columns (Table)</h4>
                                <div id="single-cols-container" class="space-y-2 mb-2"></div>
                                <button onclick="addCustomCol('single-cols-container')" class="w-full py-2 border-2 border-dashed border-astra-blue/50 dark:border-slate-500 rounded-lg text-xs font-bold text-astra-blue hover:bg-blue-50/50 dark:hover:bg-slate-700 transition active:scale-[0.99]">+ Add Column</button>
                             </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="prevStep(3)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="updateBoardTypeVisualsFinal(); nextStep(5)" class="bg-gradient-to-r from-astra-blue to-astra-purple text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-astra-purple/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next: Board Layout</button>
                    </div>
                </div>

                <!-- Step 6: Review (Logical Step 6) -->
                <div id="step-5" class="wizard-step hidden animate-scale-in">
                     <h2 class="text-3xl font-black text-blue-900 dark:text-white mb-6 text-center">Ready to <span class="text-gradient">Launch</span>?</h2>

                     <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700 p-8 mb-8 max-w-2xl mx-auto relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-astra-blue shadow-lg shadow-blue-400/50"></div>

                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <div class="text-xs font-bold text-astra-blue uppercase tracking-wider mb-1" id="sum-cat">SPORTS</div>
                                <h3 class="text-2xl font-black text-slate-800 dark:text-white" id="sum-name">My Scoreboard</h3>
                            </div>
                            <div class="bg-slate-100 dark:bg-slate-700 px-3 py-1 rounded-full text-xs font-bold text-slate-500" id="sum-type">TEAMS</div>
                        </div>

                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">Participants</div>
                                <div class="font-bold text-lg text-slate-700 dark:text-slate-200" id="sum-count">8 Teams</div>
                                <ul class="text-xs text-slate-500 mt-1 list-disc pl-4" id="sum-part-preview">
                                    </ul>
                            </div>
                             <div>
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">Scoring</div>
                                <ul class="text-sm font-medium text-slate-600 dark:text-slate-300 space-y-1" id="sum-rules">
                                    </ul>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 dark:border-slate-700 pt-4">
                            <div class="flex gap-2 flex-wrap" id="sum-tags">
                                </div>
                        </div>
                     </div>

                     <div class="flex justify-between items-center pt-6 max-w-2xl mx-auto">
                        <button onclick="prevStep(5)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="createScoreboard()" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-10 py-4 rounded-xl font-black text-xl shadow-xl shadow-green-500/40 transition transform hover:-translate-y-1 w-full md:w-auto active:scale-[0.98]">
                            ðŸš€ Create Scoreboard
                        </button>
                    </div>
                </div>

            </div>

            <!-- Festival Mode Flow -->
            <div id="festival-mode-flow" class="hidden">
                <!-- Fest Step 1: Details (REDESIGNED) -->
                <div id="fest-step-1" class="wizard-step animate-scale-in">
                    <!-- Clean Header Section -->
                    <div class="text-center mb-8">
                        <div class="w-16 h-16 bg-gradient-to-br from-astra-purple to-astra-pink rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg shadow-purple-500/30">
                            <i class="fas fa-calendar-star text-3xl text-white"></i>
                        </div>
                        <h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-astra-purple to-astra-pink mb-2">Mega Event Details</h2>
                        <p class="text-slate-500 dark:text-slate-400 font-medium">Let's build something legendary.</p>
                    </div>

                    <!-- Clean Input Card -->
                    <div class="max-w-3xl mx-auto bg-white/50 dark:bg-slate-800/50 backdrop-blur-sm p-8 rounded-3xl border border-white dark:border-slate-700 shadow-xl">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-astra-purple mb-1 uppercase tracking-wide ml-1">Festival Name</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <i class="fas fa-signature text-purple-300"></i>
                                    </div>
                                    <input type="text" id="fest-input-name" onkeydown="handleEnter(event, () => nextFestStep(2))" class="w-full pl-11 pr-4 py-4 rounded-xl bg-purple-50/30 dark:bg-slate-900/50 border-2 border-purple-100 dark:border-slate-600 focus:border-astra-purple dark:text-white font-bold text-lg text-blue-900 transition-all outline-none placeholder-purple-200 dark:placeholder-slate-600" placeholder="e.g. Inter-School TechFest 2025" autofocus>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-astra-purple mb-1 uppercase tracking-wide ml-1">Organizer</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <i class="fas fa-building text-purple-300"></i>
                                    </div>
                                    <input type="text" id="fest-input-organizer" onkeydown="handleEnter(event, () => nextFestStep(2))" class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50/50 dark:bg-slate-900/50 border-2 border-slate-100 dark:border-slate-600 focus:border-astra-purple/50 dark:text-white font-medium text-slate-700 outline-none transition-all" placeholder="School / Org Name">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-astra-purple mb-1 uppercase tracking-wide ml-1">Location</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <i class="fas fa-map-marker-alt text-purple-300"></i>
                                    </div>
                                    <input type="text" id="fest-input-location" onkeydown="handleEnter(event, () => nextFestStep(2))" class="w-full pl-11 pr-4 py-3 rounded-xl bg-slate-50/50 dark:bg-slate-900/50 border-2 border-slate-100 dark:border-slate-600 focus:border-astra-purple/50 dark:text-white font-medium text-slate-700 outline-none transition-all" placeholder="City or Campus">
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-astra-purple mb-1 uppercase tracking-wide ml-1">Start Date</label>
                                <input type="date" id="fest-input-start" onkeydown="handleEnter(event, () => nextFestStep(2))" class="w-full p-3 rounded-xl bg-slate-50/50 dark:bg-slate-900/50 border-2 border-slate-100 dark:border-slate-600 focus:border-astra-purple/50 dark:text-white font-medium text-slate-700 outline-none transition-all text-sm">
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-astra-purple mb-1 uppercase tracking-wide ml-1">End Date</label>
                                <input type="date" id="fest-input-end" onkeydown="handleEnter(event, () => nextFestStep(2))" class="w-full p-3 rounded-xl bg-slate-50/50 dark:bg-slate-900/50 border-2 border-slate-100 dark:border-slate-600 focus:border-astra-purple/50 dark:text-white font-medium text-slate-700 outline-none transition-all text-sm">
                            </div>
                        </div>

                        <!-- Entity Accordion (Clean) -->
                        <div class="border-t border-slate-100 dark:border-slate-700 pt-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-sm text-astra-purple dark:text-purple-300 flex items-center">
                                    <i class="fas fa-university mr-2"></i> Global Teams / Schools
                                </h3>
                                <button onclick="openFestivalEntityModal()" class="text-xs bg-purple-100 dark:bg-slate-700 text-astra-purple dark:text-purple-300 px-3 py-1 rounded-lg font-bold hover:bg-purple-200 transition">
                                    <i class="fas fa-plus mr-1"></i> Add Entity
                                </button>
                            </div>
                            
                            <div id="festival-entities-list" class="space-y-2 max-h-32 overflow-y-auto mb-2 p-1">
                                <p class="text-xs text-slate-400 italic text-center py-2">No entities added yet (Optional)</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-center">
                        <button class="bg-gradient-to-r from-astra-purple to-astra-pink text-white px-12 py-4 rounded-full font-black text-lg hover:shadow-xl hover:shadow-pink-500/30 transition transform hover:-translate-y-1 active:scale-[0.98] flex items-center gap-3 group" onclick="nextFestStep(2)">
                            Start Building <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Sub-Events (New UI: fest-step-subevents) -->
                <div id="fest-step-subevents" class="wizard-step hidden animate-scale-in">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h2 class="text-3xl font-black text-astra-purple dark:text-white">Define <span class="text-gradient">Sub-Events</span></h2>
                            <p class="text-slate-500 text-sm font-bold">Create the individual competitions for your festival.</p>
                        </div>
                        <button onclick="showSubEventModal()" class="bg-purple-100 text-astra-purple px-4 py-2 rounded-lg text-sm font-black hover:bg-purple-200 transition active:scale-[0.98] shadow-md"><i class="fas fa-plus mr-2"></i>Add Sub-Event</button>
                    </div>

                    <div id="subevents-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 min-h-[200px] content-start">
                        <div id="subevents-empty" class="col-span-full text-center py-12 bg-slate-50 dark:bg-slate-700/50 rounded-2xl border-2 border-dashed border-slate-300 dark:border-slate-600">
                            <i class="fas fa-clipboard-list text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-400 font-bold text-sm">No sub-events added yet.</p>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="showFestStep(1)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="nextFestStep(3)" class="bg-gradient-to-r from-astra-purple to-astra-pink text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-pink-500/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next: Participants</button>
                    </div>
                </div>

                <!-- Step 3: Participants (fest-step-participants) -->
                <div id="fest-step-participants" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-astra-purple dark:text-white mb-2 text-center"><span class="text-gradient">Participants</span></h2>
                    <p class="text-center text-slate-500 text-sm font-bold mb-8">Manage who is competing in each event.</p>

                    <div id="participants-overview-container" class="space-y-4 mb-8">
                        </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="nextFestStep(2)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="nextFestStep(4)" class="bg-gradient-to-r from-astra-purple to-astra-pink text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-pink-500/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Next: Stages</button>
                    </div>
                </div>

                <!-- Step 4: Stages (fest-step-stages) -->
                <div id="fest-step-stages" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-astra-purple dark:text-white mb-2 text-center">Stages & <span class="text-gradient">Scoreboards</span></h2>
                    <p class="text-center text-slate-500 text-sm font-bold mb-8">Define rounds and attach scoreboards.</p>

                    <div id="stages-overview-container" class="space-y-6 mb-8 max-h-[400px] overflow-y-auto scrollbar-thin pr-2">
                        </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 dark:border-slate-700">
                        <button onclick="nextFestStep(3)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="nextFestStep(5)" class="bg-gradient-to-r from-astra-purple to-astra-pink text-white px-8 py-3 rounded-xl font-black hover:shadow-lg hover:shadow-pink-500/30 transition transform hover:-translate-y-0.5 active:scale-[0.98]">Review Festival</button>
                    </div>
                </div>

                <!-- Step 5: Summary (fest-step-summary-new) -->
                <div id="fest-step-summary-new" class="wizard-step hidden animate-scale-in">
                    <h2 class="text-3xl font-black text-astra-purple dark:text-white mb-6 text-center">Ready to <span class="text-gradient">Launch Festival</span>?</h2>

                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-purple-100 dark:border-slate-600 p-8 mb-8 max-w-3xl mx-auto relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-astra-purple shadow-lg shadow-purple-400/50"></div>

                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <div class="text-xs font-bold text-astra-purple uppercase tracking-wider mb-1">MEGA EVENT</div>
                                <h3 class="text-3xl font-black text-slate-800 dark:text-white" id="fest-sum-name">My Festival</h3>
                                <p class="text-sm font-bold text-slate-400" id="fest-sum-org">Organizer</p>
                            </div>
                            <div class="bg-purple-100 dark:bg-slate-700 px-4 py-2 rounded-full text-sm font-bold text-astra-purple dark:text-purple-300 shadow-md">
                                <i class="fas fa-calendar-alt mr-2"></i> <span id="fest-sum-dates">Dates</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-xl text-center shadow-inner">
                                <div class="text-3xl font-black text-slate-700 dark:text-white" id="fest-sum-events-count">0</div>
                                <div class="text-xs font-bold text-slate-400 uppercase">Sub-Events</div>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-xl text-center shadow-inner">
                                <div class="text-3xl font-black text-slate-700 dark:text-white" id="fest-sum-stages-count">0</div>
                                <div class="text-xs font-bold text-slate-400 uppercase">Total Stages</div>
                            </div>
                            <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-xl text-center shadow-inner">
                                <div class="text-3xl font-black text-green-500" id="fest-sum-boards-count">0</div>
                                <div class="text-xs font-bold text-slate-400 uppercase">Scoreboards</div>
                            </div>
                        </div>

                        <div class="p-4 bg-purple-50/50 dark:bg-slate-700 rounded-xl text-center mt-6 shadow-md border border-purple-100 dark:border-slate-700">
                            <div class="text-3xl font-black text-astra-purple" id="fest-sum-entities-count">0</div>
                            <div class="text-xs font-bold text-slate-400 uppercase">Festival Entities Defined</div>
                        </div>
                        <div class="border-t border-slate-100 dark:border-slate-700 pt-4 mt-6">
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Event Tree</h4>
                            <div id="fest-sum-tree" class="space-y-1 text-sm font-medium text-slate-600 dark:text-slate-300 max-h-[150px] overflow-y-auto pr-2 scrollbar-thin">
                                </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-center pt-6 max-w-3xl mx-auto">
                        <button onclick="nextFestStep(4)" class="text-slate-400 font-bold hover:text-astra-purple px-4 transition active:scale-[0.98]">Back</button>
                        <button onclick="createFestival()" class="bg-gradient-to-r from-astra-purple to-astra-pink text-white px-10 py-4 rounded-xl font-black text-xl shadow-xl shadow-purple-500/40 transition transform hover:-translate-y-1 w-full md:w-auto active:scale-[0.98]">
                            ðŸš€ Create Festival
                        </button>
                    </div>
                </div>

                <!-- Placeholder steps (hidden but included for completeness) -->
                <div id="fest-step-2" class="wizard-step hidden"></div>
                <div id="fest-step-3" class="wizard-step hidden"></div>
            </div>
        </div>
    </div>

    <!-- MODALS (Updated styles for consistency) -->

    <div id="subevent-modal" class="hidden fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 animate-scale-in">
            <h3 class="text-xl font-black text-astra-purple dark:text-white mb-4">Add Sub-Event</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Event Name</label>
                    <input type="text" id="new-se-name" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:border-astra-purple outline-none focus:ring-1 focus:ring-astra-purple transition" placeholder="e.g. U17 Football Boys">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Category</label>
                    <select id="new-se-cat" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:border-astra-purple outline-none focus:ring-1 focus:ring-astra-purple transition" onchange="updateSubEventTypeOptions()">
                        <option value="sports">Sports</option>
                        <option value="academic">Academic</option>
                        <option value="cultural">Cultural</option>
                        <option value="esports">Esports</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Type</label>
                    <select id="new-se-type" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:border-astra-purple outline-none focus:ring-1 focus:ring-astra-purple transition">
                        </select>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="document.getElementById('subevent-modal').classList.add('hidden')" class="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition active:scale-[0.98]">Cancel</button>
                <button onclick="saveSubEvent()" class="bg-gradient-to-r from-astra-purple to-astra-pink text-white font-bold px-6 py-2 rounded-xl hover:shadow-lg hover:shadow-pink-500/30 transition active:scale-[0.98]">Add Event</button>
            </div>
        </div>
    </div>

    <div id="fest-participants-modal" class="hidden fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-6 animate-scale-in h-[500px] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-astra-purple dark:text-white">Manage Participants</h3>
                <span id="fpm-event-name" class="text-xs font-bold bg-purple-100 text-astra-purple px-2 py-1 rounded-full shadow-md">Event</span>
            </div>

            <div class="flex gap-2 mb-4">
                <input type="text" id="fpm-input" class="w-3/5 p-2 rounded-lg bg-slate-50 border border-slate-200 dark:bg-slate-700 dark:border-slate-600 text-sm font-bold focus:outline-none focus:ring-1 focus:ring-astra-purple transition" placeholder="Participant Name...">

                <select id="fpm-entity-select" class="w-2/5 p-2 rounded-lg bg-slate-50 border border-slate-200 dark:bg-slate-700 dark:border-slate-600 text-sm font-bold focus:outline-none focus:ring-1 focus:ring-astra-purple text-slate-600 dark:text-slate-300 transition">
                    <option value="">No Affiliation</option>
                </select>

                <button onclick="addFestParticipant()" class="bg-astra-purple text-white px-4 rounded-lg font-bold text-sm hover:bg-astra-blue transition active:scale-[0.98] shadow-md">Add</button>
            </div>

            <div id="fpm-list" class="flex-grow overflow-y-auto bg-slate-50 dark:bg-slate-700/50 rounded-xl p-2 space-y-2 scrollbar-thin">
                </div>

            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-slate-100 dark:border-slate-600">
                <button onclick="closeFestParticipantsModal()" class="bg-slate-200 text-slate-600 font-bold px-6 py-2 rounded-xl hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 transition active:scale-[0.98]">Done</button>
            </div>
        </div>
    </div>

    <div id="entity-modal" class="hidden fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl p-6 animate-scale-in">
            <h3 class="text-zxl font-black text-blue-900 dark:text-white mb-4" id="entity-modal-title">Add Entity</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Name</label>
                    <input type="text" id="entity-name" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:ring-1 focus:ring-astra-blue outline-none transition" placeholder="e.g. Ravenclaw">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Short Code</label>
                        <input type="text" id="entity-code" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:ring-1 focus:ring-astra-blue outline-none transition" placeholder="e.g. RVCL">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Color</label>
                        <input type="color" id="entity-color" class="w-full h-12 rounded-xl border border-slate-200 dark:border-slate-600 cursor-pointer" value="#4F46E5">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Type</label>
                        <select id="entity-type" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 font-bold focus:ring-1 focus:ring-astra-blue outline-none transition">
                            <option value="School">School</option>
                            <option value="House">House</option>
                            <option value="Team">Team</option>
                            <option value="Organisation">Organisation</option>
                        </select>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Logo URL (Optional)</label>
                         <input type="text" id="entity-logo" class="w-full p-3 rounded-xl bg-slate-50 dark:bg-slate-700 border-2 border-slate-200 dark:border-slate-600 text-sm focus:ring-1 focus:ring-astra-blue outline-none transition" placeholder="https://logo.com/img.png">
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeEntityModal()" class="text-slate-500 font-bold px-4 py-2 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition active:scale-[0.98]">Cancel</button>
                <button onclick="saveEntity()" class="bg-astra-blue text-white font-bold px-6 py-2 rounded-xl hover:bg-astra-purple shadow-lg shadow-blue-500/30 transition active:scale-[0.98]" id="entity-save-btn">Save Entity</button>
            </div>
        </div>
    </div>
    <script>
        // ==========================================
        // 1. STATE MANAGEMENT
        // ==========================================
        const singleConfig = {
            category: null, // sports, academic, cultural, esports
            participantType: 'teams', // teams, individuals, houses
            participants: [],
            scoring: {},
            layout: {
                name: '',
                theme: 'light',
                customRows: [],
                customColumns: []
            },
            boardTypes: [], // ADDED
            entities: []
        };

        // Festival config
        let festivalConfig = {
            name: '',
            organizer: '',
            dates: '',
            subEvents: [],
            entities: []
        };

        // Helper for Enter Key in inputs
        function handleEnter(event, nextStepFn) {
            if (event.key === "Enter") {
                event.preventDefault();
                nextStepFn();
            }
        }

        // ==========================================
        // 2. MODE SWITCHING (Adapted for new styles)
        // ==========================================
        function switchMode(mode) {
            const singleBtn = document.getElementById('btn-mode-single');
            const festBtn = document.getElementById('btn-mode-fest');
            const singleFlow = document.getElementById('single-mode-flow');
            const festFlow = document.getElementById('festival-mode-flow');
            const progressBar = document.getElementById('progress-bar');
            const stepper = document.getElementById('stepper-container');

            if (mode === 'single') {
                singleBtn.className = "px-6 py-3 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-astra-blue to-astra-purple text-white shadow-lg shadow-blue-400/50 hover:opacity-90 active:scale-[0.98]";
                festBtn.className = "px-6 py-3 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-blue dark:text-slate-400 hover:bg-white dark:hover:bg-slate-700 active:scale-[0.98]";

                singleFlow.classList.remove('hidden');
                festFlow.classList.add('hidden');

                // Update Progress Bar color for single mode
                progressBar.classList.remove('bg-purple-500', 'shadow-[0_0_15px_rgba(168,85,247,0.5)]');
                progressBar.classList.add('bg-astra-blue', 'shadow-md', 'shadow-blue-400/50');

                // Show stepper and reset to step 1
                stepper.classList.remove('opacity-0');
                stepper.classList.add('transition-opacity', 'duration-500');
                showStep(1);
            } else {
                singleBtn.className = "px-6 py-3 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-purple dark:text-slate-400 hover:bg-white dark:hover:bg-slate-700 active:scale-[0.98]";
                festBtn.className = "px-6 py-3 rounded-full font-bold text-sm transition-all bg-gradient-to-r from-astra-purple to-astra-pink text-white shadow-lg shadow-purple-500/50 hover:opacity-90 active:scale-[0.98]";

                singleFlow.classList.add('hidden');
                festFlow.classList.remove('hidden');

                // Update Progress Bar color for festival mode
                progressBar.classList.remove('bg-astra-blue', 'shadow-md', 'shadow-blue-400/50');
                progressBar.classList.add('bg-astra-purple', 'shadow-md', 'shadow-purple-400/50');

                // Hide stepper for festival mode (or just use custom flow dots)
                stepper.classList.add('opacity-0');
                nextFestStep(1);
            }
        }

        // ==========================================
        // 3. SINGLE WIZARD NAVIGATION (Modified for 6 steps)
        // ==========================================
        let currentStep = 1;

        function showStep(step) {
            let targetId = '';
            let dotIndex = 0;
            const totalDots = 6;

            if(step === 1) { targetId = 'step-1'; dotIndex = 1; }
            else if(step === 2) { targetId = 'step-2'; dotIndex = 2; }
            else if(step === 3) { targetId = 'step-3'; dotIndex = 3; }
            else if(step === 4) { targetId = 'step-4'; dotIndex = 4; }
            else if(step === 5) { targetId = 'step-layout-board-select'; dotIndex = 5; } // New Step 5
            else if(step === 6) { targetId = 'step-5'; dotIndex = 6; } // Original Step 5 is now 6

            document.querySelectorAll('#single-mode-flow .wizard-step').forEach(el => el.classList.add('hidden'));

            const targetEl = document.getElementById(targetId);
            if (targetEl) {
                targetEl.classList.remove('hidden');
                // Re-apply scale-in animation on step change
                targetEl.style.animation = 'none';
                void targetEl.offsetWidth; // Trigger reflow
                targetEl.style.animation = 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
            } else {
                 console.error(`Step ID not found for logical step ${step}. Target ID: ${targetId}`);
                 return;
            }

            // Update Dots (Enhanced styles)
            for(let i=1; i<=totalDots; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if(dot) {
                    dot.classList.remove('bg-astra-blue', 'shadow-md', 'scale-125', 'bg-slate-300', 'dark:bg-slate-700');
                    if(i <= dotIndex) {
                        dot.classList.add('bg-astra-blue', 'shadow-md');
                    } else {
                        dot.classList.add('bg-slate-300', 'dark:bg-slate-700');
                    }
                    if(i === dotIndex) {
                        dot.classList.add('scale-125');
                    } else {
                        dot.classList.remove('scale-125');
                    }
                }
            }

            // Update Bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${(dotIndex/totalDots)*100}%`;

            window.currentStep = step;
        }

        function nextStep(step) {
            if (step === 2) {
                if (!singleConfig.category) { alert("Please select a game type first."); return; }
                showStep(2);
                return;
            }

            if (step === 3) {
                 document.querySelectorAll('.cat-panel').forEach(p => p.classList.add('hidden'));
                 document.getElementById(`panel-${singleConfig.category}`).classList.remove('hidden');
                 if(singleConfig.category === 'sports') updateSportFields();
                 if(singleConfig.category === 'academic') updateAcadFields();
            }

            if (step === 5) {
                updateBoardTypeVisualsFinal();
                showStep(5);
                return;
            }

            if (step === 6) {
                generateSummary();
            }

            showStep(step);
        }

        function prevStep(step) {
            showStep(step);
        }

        // ==========================================
        // 4. STEP 1: CATEGORY (Adapted for new selection ring color)
        // ==========================================
        function selectCategory(cat, el) {
            singleConfig.category = cat;

            // Visual Selection
            document.querySelectorAll('.cat-card').forEach(c => c.classList.remove('ring-4', 'ring-astra-blue'));
            el.classList.add('ring-4', 'ring-astra-blue');

            // Update Subtitle in Step 3
            const subtitles = {
                sports: 'Game Type: Sports',
                academic: 'Game Type: Academic / Knowledge',
                cultural: 'Game Type: Cultural / Arts',
                esports: 'Game Type: Esports / Gaming'
            };
            document.getElementById('scoring-subtitle').textContent = subtitles[cat];

            // Pre-configure Step 3 default unit
            const units = { sports: 'Points', academic: 'Points', cultural: 'Score', esports: 'Rounds' };
            document.getElementById('score-unit').value = units[cat];
        }

        // ==========================================
        // 5. STEP 2: PARTICIPANTS
        // ==========================================
        function setParticipantType(type) {
            singleConfig.participantType = type;

            // Button Styles (Updated styles for consistency)
            ['teams', 'individuals', 'houses'].forEach(t => {
                const btn = document.getElementById(`pt-${t}`);
                if(t === type) {
                    btn.className = "px-6 py-2 rounded-full font-bold text-sm transition-all bg-white text-astra-blue shadow-md dark:bg-slate-800 dark:text-white";
                } else {
                    btn.className = "px-6 py-2 rounded-full font-bold text-sm transition-all text-slate-500 hover:text-astra-blue dark:hover:text-white";
                }
            });

            // Label Update
            const labels = { teams: 'How many teams?', individuals: 'How many participants?', houses: 'How many houses?' };
            document.getElementById('count-label').textContent = labels[type];

            // Clear list on switch
            document.getElementById('participants-list').innerHTML = '';
            singleConfig.participants = [];

            // Toggle Individual Entities Section
            const entitySection = document.getElementById('individual-entities-section');
            if (type === 'individuals') {
                entitySection.classList.remove('hidden');
                renderSingleEntities();
            } else {
                entitySection.classList.add('hidden');
            }
        }

        function generateParticipants(count) {
            const container = document.getElementById('participants-list');
            container.innerHTML = '';
            singleConfig.participants = [];

            for(let i=0; i<count; i++) {
                addParticipant(i+1);
            }
        }

        function addParticipant(num = null) {
            const container = document.getElementById('participants-list');
            const idx = container.children.length + 1;
            const type = singleConfig.participantType;

            // Dynamic Placeholders
            let namePH = type === 'teams' ? `Team ${idx}` : (type === 'houses' ? `House ${idx}` : `Player ${idx}`);
            // let codePH = type === 'teams' ? `T${idx}` : (type === 'houses' ? `H${idx}` : `P${idx}`); // unused in UI

            // ADDED: Create participant object
            const participantId = `p-${Date.now()}-${idx}`;
            // Use a specific color palette for better initial visuals
            const defaultColors = ['#4F46E5', '#9333ea', '#10b981', '#f97316', '#ef4444', '#06b6d4'];
            const defaultColor = defaultColors[(idx - 1) % defaultColors.length];

            singleConfig.participants.push({
                id: participantId,
                name: namePH,
                color: defaultColor,
                representsEntityId: null
            });

            const div = document.createElement('div');
            div.className = "bg-slate-50 dark:bg-slate-700 p-3 rounded-xl border border-slate-200 dark:border-slate-600 flex gap-2 items-center flex-wrap animate-fade-in transition-shadow hover:shadow-md";
            div.setAttribute('data-participant-id', participantId);

            let representsDropdown = '';
            if (type === 'individuals') {
                representsDropdown = `
                    <select onchange="updateParticipantEntity('${participantId}', this.value)" class="w-full mt-2 p-2 rounded-lg bg-white dark:bg-slate-800 text-xs font-medium text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700 focus:ring-1 focus:ring-astra-blue">
                        <option value="">Represents â†’ (Optional)</option>
                        ${singleConfig.entities.map(e => `<option value="${e.id}">${e.name} (${e.shortCode})</option>`).join('')}
                    </select>
                `;
            }

            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-white dark:bg-slate-600 border border-slate-200 flex items-center justify-center font-bold text-xs text-slate-400">${idx}</div>
                <input type="text" placeholder="${namePH}" value="${namePH}" onchange="updateParticipantName('${participantId}', this.value)" class="flex-grow bg-transparent text-sm font-bold text-slate-700 dark:text-white outline-none border-b border-transparent focus:border-astra-blue transition">
                <input type="color" onchange="updateParticipantColor('${participantId}', this.value)" class="w-6 h-6 rounded-full overflow-hidden cursor-pointer border-none bg-transparent" value="${singleConfig.participants[singleConfig.participants.length - 1].color}">
                <button onclick="removeParticipant('${participantId}', this.parentElement)" class="text-slate-300 hover:text-red-400 transition active:scale-[0.9]"><i class="fas fa-times"></i></button>
                ${representsDropdown}
            `;
            container.appendChild(div);
        }

        function updateParticipantName(id, name) {
            const part = singleConfig.participants.find(p => p.id === id);
            if(part) part.name = name;
        }
        function updateParticipantColor(id, color) {
            const part = singleConfig.participants.find(p => p.id === id);
            if(part) part.color = color;
        }
        function updateParticipantEntity(id, entityId) {
            const part = singleConfig.participants.find(p => p.id === id);
            if(part) part.representsEntityId = entityId || null;
        }
        function removeParticipant(id, el) {
            const idx = singleConfig.participants.findIndex(p => p.id === id);
            if(idx !== -1) singleConfig.participants.splice(idx, 1);
            el.remove();
        }

        // ADDED: Entity Management Logic
        let activeEntityConfig = null;
        let currentEntityMode = 'single';

        function openSingleEntityModal() {
            currentEntityMode = 'single';
            activeEntityConfig = null;
            document.getElementById('entity-modal-title').textContent = 'Add Individual Entity';
            document.getElementById('entity-save-btn').textContent = 'Add Entity';
            document.getElementById('entity-save-btn').className = 'bg-astra-blue text-white font-bold px-6 py-2 rounded-xl hover:bg-astra-purple shadow-lg shadow-blue-500/30 transition active:scale-[0.98]';
            document.getElementById('entity-color').value = '#4F46E5';
            document.getElementById('entity-modal').classList.remove('hidden');
            document.getElementById('entity-name').value = '';
            document.getElementById('entity-code').value = '';
            document.getElementById('entity-type').value = 'School';
            document.getElementById('entity-logo').value = '';
        }

        function openFestivalEntityModal() {
            currentEntityMode = 'festival';
            activeEntityConfig = null;
            document.getElementById('entity-modal-title').textContent = 'Add Festival Entity';
            document.getElementById('entity-save-btn').textContent = 'Add Entity';
            document.getElementById('entity-save-btn').className = 'bg-astra-purple text-white font-bold px-6 py-2 rounded-xl hover:bg-astra-pink shadow-lg shadow-purple-500/30 transition active:scale-[0.98]';
            document.getElementById('entity-color').value = '#9333ea';
            document.getElementById('entity-modal').classList.remove('hidden');
            document.getElementById('entity-name').value = '';
            document.getElementById('entity-code').value = '';
            document.getElementById('entity-type').value = 'School';
            document.getElementById('entity-logo').value = '';
        }

        function closeEntityModal() {
            document.getElementById('entity-modal').classList.add('hidden');
        }

        function saveEntity() {
            const name = document.getElementById('entity-name').value.trim();
            const shortCode = document.getElementById('entity-code').value.trim().toUpperCase();
            const type = document.getElementById('entity-type').value;
            const color = document.getElementById('entity-color').value;
            const logoUrl = document.getElementById('entity-logo').value.trim();

            if (!name || !shortCode) {
                // Use a custom message box instead of alert()
                showTemporaryMessage("Name and Short Code are required.", "error");
                return;
            }

            const newEntity = {
                id: `ent-${Date.now()}`,
                name, shortCode, type, color, logoUrl
            };

            if (currentEntityMode === 'single') {
                singleConfig.entities.push(newEntity);
                renderSingleEntities();
                updateAllParticipantDropdowns();
            } else if (currentEntityMode === 'festival') {
                festivalConfig.entities.push(newEntity);
                renderFestivalEntities();
            }

            closeEntityModal();
        }

        function removeEntity(id) {
            const list = currentEntityMode === 'single' ? singleConfig.entities : festivalConfig.entities;
            const idx = list.findIndex(e => e.id === id);
            if (idx !== -1) {
                list.splice(idx, 1);
                if (currentEntityMode === 'single') {
                    renderSingleEntities();
                    updateAllParticipantDropdowns();
                } else if (currentEntityMode === 'festival') {
                    renderFestivalEntities();
                }
            }
        }

        function renderSingleEntities() {
            const container = document.getElementById('single-entities-list');
            container.innerHTML = singleConfig.entities.length === 0
                ? '<p class="text-sm text-slate-400 text-center py-2">No entities defined yet.</p>'
                : singleConfig.entities.map(e => `
                    <div class="flex justify-between items-center p-2 rounded-lg bg-slate-100 dark:bg-slate-700 transition hover:shadow-inner">
                        <div class="flex items-center">
                            <div class="w-2 h-6 rounded-l-md mr-2 shadow-md" style="background-color: ${e.color};"></div>
                            <span class="text-sm font-bold text-slate-700 dark:text-white">${e.name}</span>
                            <span class="ml-2 text-xs font-medium text-slate-500">(${e.shortCode})</span>
                            <span class="ml-2 text-xs font-bold text-astra-blue">${e.type}</span>
                        </div>
                        <button onclick="removeEntity('${e.id}')" class="text-slate-400 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');
        }

        function updateAllParticipantDropdowns() {
            if (singleConfig.participantType !== 'individuals') return;

            document.querySelectorAll('#participants-list select').forEach(select => {
                const participantId = select.closest('[data-participant-id]').getAttribute('data-participant-id');
                const selectedId = select.value;

                select.innerHTML = `<option value="">Represents â†’ (Optional)</option>` +
                    singleConfig.entities.map(e =>
                        `<option value="${e.id}" ${e.id === selectedId ? 'selected' : ''}>${e.name} (${e.shortCode})</option>`
                    ).join('');

                if (selectedId && !singleConfig.entities.find(e => e.id === selectedId)) {
                    updateParticipantEntity(participantId, null);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
             renderSingleEntities();
             // Initialise mode to single and step 1
             switchMode('single');
        });

        // ==========================================
        // 6. STEP 3: SCORING CONFIG
        // ==========================================
        function updateSportFields() {
            const type = document.getElementById('sport-type').value;
            const container = document.getElementById('sport-specific-options');

            let html = '';
            if (type === 'football' || type === 'basketball') {
                html = `
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Periods</label><input type="number" value="2" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm font-bold border border-slate-200 dark:border-slate-600"></div>
                        <div><label class="text-[10px] font-bold uppercase text-slate-400">Mins/Period</label><input type="number" value="${type==='football'?45:10}" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm font-bold border border-slate-200 dark:border-slate-600"></div>
                    </div>
                    <div class="mt-3 flex gap-4">
                        <label class="text-xs font-bold text-slate-500 dark:text-slate-400"><input type="checkbox" class="accent-orange-500"> Track Fouls</label>
                        <label class="text-xs font-bold text-slate-500 dark:text-slate-400"><input type="checkbox" class="accent-orange-500"> Track Cards</label>
                    </div>
                `;
            } else if (type === 'custom') {
                html = `<input type="text" placeholder="One-line summary of scoring rules..." class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm border border-slate-200 dark:border-slate-600">`;
            }
            container.innerHTML = html;
        }

        function updateAcadFields() {
            const type = document.querySelector('input[name="acad-type"]:checked').value;
            const container = document.getElementById('acad-specific-options');

            if (type === 'quiz') {
                container.innerHTML = `
                    <div class="flex gap-4">
                        <div class="w-1/2"><label class="text-[10px] font-bold uppercase text-slate-400">Points/Correct</label><input type="number" value="10" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm font-bold border border-slate-200 dark:border-slate-600"></div>
                        <div class="w-1/2"><label class="text-[10px] font-bold uppercase text-slate-400">Neg. Marking</label><input type="number" value="0" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm font-bold border border-slate-200 dark:border-slate-600"></div>
                    </div>
                `;
            } else if (type === 'debate') {
                container.innerHTML = `
                    <div><label class="text-[10px] font-bold uppercase text-slate-400">Number of Judges</label><input type="number" value="3" class="w-full p-2 rounded bg-white dark:bg-slate-800 text-sm font-bold border border-slate-200 dark:border-slate-600"></div>
                `;
            } else {
                container.innerHTML = `<p class="text-xs text-slate-500">Generic scoring will be applied.</p>`;
            }
        }

        function addCriteriaRow() {
            const tbody = document.getElementById('criteria-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="p-1"><input type="text" placeholder="Criteria" class="w-full bg-white dark:bg-slate-800 p-2 rounded text-sm font-bold border border-slate-200 dark:border-slate-600 focus:border-pink-500"></td>
                <td class="p-1"><input type="number" value="10" class="w-full bg-white dark:bg-slate-800 p-2 rounded text-sm border border-slate-200 dark:border-slate-600 focus:border-pink-500"></td>
                <td class="p-1 text-center"><button onclick="this.parentElement.parentElement.remove()" class="text-slate-400 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        // ==========================================
        // 7. CUSTOM LAYOUT
        // ==========================================
        function addCustomRow(containerId) {
            const container = document.getElementById(containerId);
            container.insertAdjacentHTML('beforeend', `
                <div class="flex gap-2 animate-scale-in">
                    <input type="text" placeholder="Stat Name" class="flex-grow p-2 rounded text-xs font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 focus:ring-1 focus:ring-astra-blue">
                    <button onclick="this.parentElement.remove()" class="text-red-400 px-2 hover:text-red-600 transition active:scale-[0.9]"><i class="fas fa-times"></i></button>
                </div>
            `);
        }
        function addCustomCol(containerId) {
            const container = document.getElementById(containerId);
            container.insertAdjacentHTML('beforeend', `
                <div class="flex gap-2 animate-scale-in">
                    <input type="text" placeholder="Col Name" class="flex-grow p-2 rounded text-xs font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 focus:ring-1 focus:ring-astra-blue">
                    <button onclick="this.parentElement.remove()" class="text-red-400 px-2 hover:text-red-600 transition active:scale-[0.9]"><i class="fas fa-times"></i></button>
                </div>
            `);
        }

        // ==========================================
        // 8. BOARD SELECTION
        // ==========================================
        function validateBoardStepFinal() {
            if (singleConfig.boardTypes.length === 0) {
                document.getElementById('board-error-final').classList.remove('hidden');
                return;
            }
            document.getElementById('board-error-final').classList.add('hidden');
            nextStep(6);
        }

        function toggleBoardType(type, el) {
            const idx = singleConfig.boardTypes.indexOf(type);
            const checkIcon = el.querySelector('.check-icon');

            if (idx === -1) {
                singleConfig.boardTypes.push(type);
                el.classList.add('border-astra-blue', 'ring-2', 'ring-blue-100');
                el.classList.remove('border-slate-200', 'dark:border-slate-600');
                checkIcon.classList.remove('opacity-0');
                checkIcon.classList.add('opacity-100', 'scale-110');
            } else {
                singleConfig.boardTypes.splice(idx, 1);
                el.classList.remove('border-astra-blue', 'ring-2', 'ring-blue-100');
                el.classList.add('border-slate-200', 'dark:border-slate-600');
                checkIcon.classList.remove('opacity-100', 'scale-110');
                checkIcon.classList.add('opacity-0');
            }

            if(singleConfig.boardTypes.length > 0) {
                document.getElementById('board-error-final').classList.add('hidden');
            }
        }

        function updateBoardTypeVisualsFinal() {
            const badge = document.getElementById('category-badge-final');
            badge.textContent = `Category: ${singleConfig.category.toUpperCase()}`;

            const recs = {
                sports: ['sports-scoreboard', 'leaderboard'],
                academic: ['leaderboard', 'scoresheet'],
                cultural: ['scoreboard', 'scoresheet'],
                esports: ['sports-scoreboard', 'leaderboard']
            };

            const recommended = recs[singleConfig.category] || [];

            document.querySelectorAll('#step-layout-board-select .board-type-card').forEach(card => {
                const onclickVal = card.getAttribute('onclick');
                const type = onclickVal.match(/'([^']+)'/)[1];
                const tag = card.querySelector('.rec-tag');

                if(recommended.includes(type)) {
                    tag.classList.remove('hidden');
                } else {
                    tag.classList.add('hidden');
                }

                // Ensure existing selections are visually marked
                const checkIcon = card.querySelector('.check-icon');
                if (singleConfig.boardTypes.includes(type)) {
                    card.classList.add('border-astra-blue', 'ring-2', 'ring-blue-100');
                    card.classList.remove('border-slate-200', 'dark:border-slate-600');
                    checkIcon.classList.remove('opacity-0');
                    checkIcon.classList.add('opacity-100', 'scale-110');
                } else {
                    card.classList.remove('border-astra-blue', 'ring-2', 'ring-blue-100');
                    card.classList.add('border-slate-200', 'dark:border-slate-600');
                    checkIcon.classList.remove('opacity-100', 'scale-110');
                    checkIcon.classList.add('opacity-0');
                }
            });
        }

        // ==========================================
        // 9. SUMMARY & CREATE
        // ==========================================
        function generateSummary() {
            document.getElementById('sum-cat').textContent = singleConfig.category.toUpperCase() || 'EVENT';
            document.getElementById('sum-name').textContent = document.getElementById('layout-name').value || 'Untitled Event';
            document.getElementById('sum-type').textContent = singleConfig.participantType.toUpperCase();

            const count = singleConfig.participants.length;
            document.getElementById('sum-count').textContent = `${count} ${singleConfig.participantType}`;

            const previewUL = document.getElementById('sum-part-preview');
            previewUL.innerHTML = '';
            for(let i=0; i<Math.min(3, count); i++) {
                const part = singleConfig.participants[i];
                let val = part.name;

                if (singleConfig.participantType === 'individuals' && part.representsEntityId) {
                    const entity = singleConfig.entities.find(e => e.id === part.representsEntityId);
                    if (entity) {
                        val += ` (${entity.shortCode})`;
                    }
                }

                previewUL.innerHTML += `<li>${val}</li>`;
            }
            if(count > 3) previewUL.innerHTML += `<li>+ ${count - 3} more...</li>`;

            const rulesUL = document.getElementById('sum-rules');
            const unit = document.getElementById('score-unit').value;
            const neg = document.getElementById('allow-negative').checked;
            rulesUL.innerHTML = `
                <li><i class="fas fa-check text-green-500 mr-2"></i>Unit: ${unit}</li>
                <li><i class="fas fa-${neg?'check text-green-500':'times text-red-400'} mr-2"></i>Negative Scores</li>
            `;

            if (singleConfig.boardTypes.length > 0) {
                 rulesUL.innerHTML += `<li><i class="fas fa-list-alt text-green-500 mr-2"></i>Boards: ${singleConfig.boardTypes.join(', ')}</li>`;
            }

            const tagsDiv = document.getElementById('sum-tags');
            const rows = document.getElementById('single-rows-container').children.length;
            const cols = document.getElementById('single-cols-container').children.length;
            let tagsHTML = '';
            if(rows > 0) tagsHTML += `<span class="bg-blue-100 text-astra-blue px-2 py-1 rounded-full text-[10px] font-bold shadow-sm">${rows} Custom Rows</span>`;
            if(cols > 0) tagsHTML += `<span class="bg-blue-100 text-astra-blue px-2 py-1 rounded-full text-[10px] font-bold shadow-sm">${cols} Custom Cols</span>`;

            if(singleConfig.entities.length > 0) tagsHTML += `<span class="bg-purple-100 text-astra-purple px-2 py-1 rounded-full text-[10px] font-bold shadow-sm">${singleConfig.entities.length} Entities</span>`;

            tagsDiv.innerHTML = tagsHTML;
        }

        // Hijack the createScoreboard function to handle attachment
        let activeStageAttachment = null;
        const originalCreateScoreboard = () => {
            console.log("Final Config:", singleConfig);
            showTemporaryMessage("Scoreboard Created! (Check Console for Config Object)", "success");
            // In a real app, this would navigate to the admin dashboard
        };

        function createScoreboard() {
            if (activeStageAttachment) {
                const { sIdx, stIdx } = activeStageAttachment;

                // Save the config to the festival object
                festivalConfig.subEvents[sIdx].stages[stIdx].scoreboardConfig = JSON.parse(JSON.stringify(singleConfig));

                // Reset Mode
                activeStageAttachment = null;

                showTemporaryMessage(`Scoreboard Attached to ${festivalConfig.subEvents[sIdx].name} - ${festivalConfig.subEvents[sIdx].stages[stIdx].name} Successfully!`, "success");

                // Switch back to Festival Flow
                document.getElementById('single-mode-flow').classList.add('hidden');
                document.getElementById('festival-mode-flow').classList.remove('hidden');

                // Go back to Stages step
                nextFestStep(4);
            } else {
                originalCreateScoreboard();
            }
        }


        // ==========================================
        // 10. FESTIVAL MODE LOGIC
        // ==========================================
        let festCurrentModeStep = 1;

        nextFestStep = function(stepNum) {
            festCurrentModeStep = stepNum;
            const steps = ['fest-step-1', 'fest-step-subevents', 'fest-step-participants', 'fest-step-stages', 'fest-step-summary-new'];
            const oldSteps = ['fest-step-2', 'fest-step-3'];

            oldSteps.forEach(id => document.getElementById(id).classList.add('hidden'));
            steps.forEach(id => document.getElementById(id).classList.add('hidden'));

            const progress = (stepNum / 5) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;

            let targetEl = null;
            if(stepNum === 1) {
                targetEl = document.getElementById('fest-step-1');
            } else if (stepNum === 2) {
                saveFestBasics();
                renderSubEvents();
                targetEl = document.getElementById('fest-step-subevents');
            } else if (stepNum === 3) {
                renderParticipantsOverview();
                targetEl = document.getElementById('fest-step-participants');
            } else if (stepNum === 4) {
                renderStagesOverview();
                targetEl = document.getElementById('fest-step-stages');
            } else if (stepNum === 5) {
                renderFestivalSummary();
                targetEl = document.getElementById('fest-step-summary-new');
            }

            if (targetEl) {
                targetEl.classList.remove('hidden');
                targetEl.style.animation = 'none';
                void targetEl.offsetWidth; // Trigger reflow
                targetEl.style.animation = 'scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
            }
        };

        function showFestStep(n) { nextFestStep(n); }

        function saveFestBasics() {
            festivalConfig.name = document.getElementById('fest-input-name').value;
            festivalConfig.organizer = document.getElementById('fest-input-organizer').value;
            const start = document.getElementById('fest-input-start').value;
            const end = document.getElementById('fest-input-end').value;
            festivalConfig.dates = `${start} to ${end}`;
        }

        function renderFestivalEntities() {
            const container = document.getElementById('festival-entities-list');
            container.innerHTML = festivalConfig.entities.length === 0
                ? '<p class="text-xs text-slate-400 italic text-center py-2">No entities added yet (Optional)</p>'
                : festivalConfig.entities.map(e => `
                    <div class="flex justify-between items-center p-2 rounded-lg bg-slate-100 dark:bg-slate-700 transition hover:shadow-inner">
                        <div class="flex items-center">
                            <div class="w-1.5 h-5 rounded-l-sm mr-2 shadow-sm" style="background-color: ${e.color};"></div>
                            <span class="text-xs font-bold text-slate-700 dark:text-white">${e.name}</span>
                            <span class="ml-1 text-[10px] font-medium text-slate-500">(${e.shortCode})</span>
                        </div>
                        <button onclick="removeEntity('${e.id}')" class="text-slate-400 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
        }

        function updateSubEventTypeOptions() {
            const cat = document.getElementById('new-se-cat').value;
            const typeSelect = document.getElementById('new-se-type');
            typeSelect.innerHTML = '';
            const opts = {
                sports: ['Football', 'Cricket', 'Basketball', 'Volleyball', 'Athletics'],
                academic: ['Quiz', 'Debate', 'Spelling Bee', 'Hackathon'],
                cultural: ['Dance Solo', 'Dance Group', 'Singing', 'Drama', 'Fashion Show'],
                esports: ['Valorant', 'BGMI/PUBG', 'FIFA', 'Rocket League']
            };
            opts[cat].forEach(o => {
                typeSelect.innerHTML += `<option value="${o}">${o}</option>`;
            });
        }

        function showSubEventModal() {
            updateSubEventTypeOptions();
            document.getElementById('new-se-name').value = '';
            document.getElementById('subevent-modal').classList.remove('hidden');
        }

        function saveSubEvent() {
            const name = document.getElementById('new-se-name').value;
            const cat = document.getElementById('new-se-cat').value;
            const type = document.getElementById('new-se-type').value;
            if(!name) {
                showTemporaryMessage("Please enter an event name.", "error");
                return;
            }

            festivalConfig.subEvents.push({
                name, category: cat, type,
                participants: [],
                stages: []
            });

            document.getElementById('subevent-modal').classList.add('hidden');
            renderSubEvents();
        }

        function renderSubEvents() {
            const container = document.getElementById('subevents-container');
            if(festivalConfig.subEvents.length === 0) {
                container.innerHTML = document.getElementById('subevents-empty').outerHTML;
                return;
            }

            container.innerHTML = '';
            festivalConfig.subEvents.forEach((se, idx) => {
                const colors = { sports: 'orange', academic: 'astra-blue', cultural: 'pink', esports: 'astra-purple' };
                const c = colors[se.category];

                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl border-l-4 border-${c}-500 shadow-md hover:shadow-lg transition relative group">
                        <button onclick="deleteSubEvent(${idx})" class="absolute top-3 right-3 text-slate-300 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-trash"></i></button>
                        <div class="text-[10px] font-bold uppercase text-${c}-500 mb-1 tracking-wide">${se.category} â€¢ ${se.type}</div>
                        <h4 class="font-black text-lg text-slate-800 dark:text-white">${se.name}</h4>
                        <div class="mt-3 flex gap-2 text-xs font-bold text-slate-400">
                            <span><i class="fas fa-users mr-1"></i> ${se.participants.length} Participants</span>
                            <span><i class="fas fa-layer-group mr-1"></i> ${se.stages.length} Stages</span>
                        </div>
                    </div>
                `;
            });
        }

        function deleteSubEvent(idx) {
            if(confirm("Are you sure you want to delete this event?")) {
                festivalConfig.subEvents.splice(idx, 1);
                renderSubEvents();
            }
        }

        function renderParticipantsOverview() {
            const container = document.getElementById('participants-overview-container');
            container.innerHTML = '';
            festivalConfig.subEvents.forEach((se, idx) => {
                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-xl flex justify-between items-center shadow-md border border-slate-100 dark:border-slate-700 hover:shadow-lg transition">
                        <div>
                            <h4 class="font-black text-slate-800 dark:text-white">${se.name}</h4>
                            <div class="text-xs text-slate-500 font-bold">${se.participants.length} Registered</div>
                        </div>
                        <button onclick="openFestParticipantsModal(${idx})" class="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 px-4 py-2 rounded-lg text-xs font-black hover:bg-purple-100 hover:text-astra-purple transition active:scale-[0.98] shadow-sm">Manage</button>
                    </div>
                `;
            });
        }

        function openFestParticipantsModal(idx) {
            currentManageEventIdx = idx;
            document.getElementById('fpm-event-name').textContent = festivalConfig.subEvents[idx].name;

            const select = document.getElementById('fpm-entity-select');
            select.innerHTML = '<option value="">No Affiliation</option>';

            festivalConfig.entities.forEach(ent => {
                select.innerHTML += `<option value="${ent.id}">${ent.name} (${ent.shortCode})</option>`;
            });

            renderFestParticipantList();
            document.getElementById('fest-participants-modal').classList.remove('hidden');
        }

        function closeFestParticipantsModal() {
            document.getElementById('fest-participants-modal').classList.add('hidden');
            renderParticipantsOverview();
        }

        function addFestParticipant() {
            const input = document.getElementById('fpm-input');
            const select = document.getElementById('fpm-entity-select');

            const name = input.value.trim();
            const entityId = select.value;

            if(!name) return;

            festivalConfig.subEvents[currentManageEventIdx].participants.push({
                name: name,
                entityId: entityId || null
            });

            input.value = '';
            select.value = '';
            renderFestParticipantList();
        }

        function renderFestParticipantList() {
            const list = document.getElementById('fpm-list');
            const parts = festivalConfig.subEvents[currentManageEventIdx].participants;
            list.innerHTML = '';

            parts.forEach((p, i) => {
                let entityBadge = '';
                if(p.entityId) {
                    const ent = festivalConfig.entities.find(e => e.id === p.entityId);
                    if(ent) {
                        entityBadge = `<span class="ml-2 text-[10px] px-2 py-0.5 rounded-full text-white font-bold shadow-sm" style="background-color: ${ent.color}">${ent.shortCode}</span>`;
                    }
                }

                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded shadow-sm border border-slate-100 dark:border-slate-600">
                        <div class="flex items-center">
                            <span class="text-sm font-bold text-slate-700 dark:text-white">${p.name}</span>
                            ${entityBadge}
                        </div>
                        <button onclick="removeFestParticipant(${i})" class="text-slate-300 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-times"></i></button>
                    </div>
                `;
            });
        }

        function removeFestParticipant(i) {
            festivalConfig.subEvents[currentManageEventIdx].participants.splice(i, 1);
            renderFestParticipantList();
        }

        function renderStagesOverview() {
            const container = document.getElementById('stages-overview-container');
            container.innerHTML = '';
            if (festivalConfig.subEvents.length === 0) {
                 container.innerHTML = '<p class="text-center text-slate-400 py-10">Add sub-events first to define stages.</p>';
                 return;
            }

            festivalConfig.subEvents.forEach((se, sIdx) => {
                let stagesHTML = '';
                se.stages.forEach((st, stIdx) => {
                    const hasBoard = st.scoreboardConfig ? true : false;
                    stagesHTML += `
                        <div class="flex items-center gap-3 mb-2 pl-4 border-l-2 border-slate-200 dark:border-slate-600 ml-2">
                            <div class="flex-grow">
                                <div class="text-sm font-bold text-slate-700 dark:text-white">${st.name}</div>
                                <div class="text-[10px] text-slate-400 uppercase font-bold">${st.type}</div>
                            </div>
                            <button onclick="attachScoreboardToStage(${sIdx}, ${stIdx})" class="${hasBoard ? 'bg-green-100 text-green-600' : 'bg-astra-purple/10 text-astra-purple'} px-3 py-1 rounded-full text-[10px] font-black uppercase hover:brightness-95 transition shadow-sm active:scale-[0.98]">
                                <i class="fas fa-${hasBoard ? 'check-circle' : 'plug'} mr-1"></i> ${hasBoard ? 'Configured' : 'Attach Board'}
                            </button>
                            <button onclick="deleteStage(${sIdx}, ${stIdx})" class="text-slate-300 hover:text-red-500 transition active:scale-[0.9]"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                });

                container.innerHTML += `
                    <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-md border border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-black text-slate-800 dark:text-white text-lg">${se.name}</h4>
                            <button onclick="addStage(${sIdx})" class="text-xs font-bold text-astra-purple hover:text-astra-blue transition active:scale-[0.98]">+ Add Stage</button>
                        </div>
                        <div class="space-y-1">
                            ${stagesHTML}
                        </div>
                        ${se.stages.length === 0 ? '<p class="text-xs text-slate-400 italic pl-2">No stages defined.</p>' : ''}
                    </div>
                `;
            });
        }

        function addStage(sIdx) {
            const name = prompt("Enter Stage Name (e.g. Semi-Finals):");
            if(!name) return;
            festivalConfig.subEvents[sIdx].stages.push({
                name,
                type: 'Knockout',
                scoreboardConfig: null
            });
            renderStagesOverview();
        }

        function deleteStage(sIdx, stIdx) {
            // Note: Using prompt as a non-alert confirmation
            if(prompt("Type 'DELETE' to confirm deletion of this stage.") === 'DELETE') {
                festivalConfig.subEvents[sIdx].stages.splice(stIdx, 1);
                renderStagesOverview();
            }
        }

        function attachScoreboardToStage(sIdx, stIdx) {
            activeStageAttachment = { sIdx, stIdx };
            const subEvent = festivalConfig.subEvents[sIdx];

            document.getElementById('festival-mode-flow').classList.add('hidden');
            document.getElementById('single-mode-flow').classList.remove('hidden');

            singleConfig.category = subEvent.category;
            singleConfig.participantType = 'teams';
            singleConfig.entities = [...festivalConfig.entities];

            // Map Fest participants (objects) to Single participants (objects)
            singleConfig.participants = subEvent.participants.map((p, i) => {
                let color = `#${Math.floor(Math.random()*16777215).toString(16)}`;
                if (p.entityId) {
                    const ent = festivalConfig.entities.find(e => e.id === p.entityId);
                    if (ent) color = ent.color;
                }

                return {
                    id: `att-p-${i}`,
                    name: p.name,
                    color: color,
                    representsEntityId: p.entityId
                };
            });

            singleConfig.boardTypes = [];

            // Reset and render step 2
            setParticipantType(singleConfig.participantType);
            const container = document.getElementById('participants-list');
            container.innerHTML = '';
            singleConfig.participants.forEach((p, i) => addParticipant(i + 1)); // Add participant populates the UI based on config.participants

            showStep(2);
        }

        function renderFestivalSummary() {
            document.getElementById('fest-sum-name').textContent = festivalConfig.name || 'Untitled Festival';
            document.getElementById('fest-sum-org').textContent = festivalConfig.organizer || 'Unknown Organizer';
            document.getElementById('fest-sum-dates').textContent = festivalConfig.dates;

            document.getElementById('fest-sum-events-count').textContent = festivalConfig.subEvents.length;
            document.getElementById('fest-sum-entities-count').textContent = festivalConfig.entities.length;

            let totalStages = 0;
            let totalBoards = 0;
            const treeDiv = document.getElementById('fest-sum-tree');
            treeDiv.innerHTML = '';

            festivalConfig.subEvents.forEach(se => {
                totalStages += se.stages.length;
                const boards = se.stages.filter(s => s.scoreboardConfig).length;
                totalBoards += boards;

                let stagesList = '';
                se.stages.forEach(st => {
                    stagesList += `<div class="pl-4 text-xs text-slate-400 flex items-center">
                        <i class="fas fa-angle-right mr-2"></i> ${st.name}
                        ${st.scoreboardConfig ? '<i class="fas fa-check text-green-500 ml-2"></i>' : '<i class="fas fa-exclamation-triangle text-orange-400 ml-2"></i>'}
                    </div>`;
                });

                treeDiv.innerHTML += `
                    <div class="mb-2">
                        <div class="flex items-center text-astra-purple dark:text-purple-300 font-bold"><i class="fas fa-folder mr-2"></i> ${se.name}</div>
                        ${stagesList}
                    </div>
                `;
            });

            document.getElementById('fest-sum-stages-count').textContent = totalStages;
            document.getElementById('fest-sum-boards-count').textContent = totalBoards;
        }

        function createFestival() {
            console.log("FULL FESTIVAL CONFIG:", festivalConfig);
            showTemporaryMessage("Festival Created! See Console for JSON.", "success");
        }


        // ==========================================
        // 11. Custom Message Box (Replaces alert/confirm)
        // ==========================================
        // NOTE: Since the prompt is running in a sandbox environment and not a full browser,
        // implementing a full modal-based alert system can be tricky. I will use a simple,
        // non-blocking toast/message system integrated into the body for better UX.

        function showTemporaryMessage(message, type = 'info', duration = 3000) {
            let messageBox = document.getElementById('custom-message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'custom-message-box';
                messageBox.className = 'fixed top-4 right-4 z-[100] p-4 rounded-xl shadow-2xl transition-all duration-300 transform translate-x-full opacity-0 font-bold text-white';
                document.body.appendChild(messageBox);
            }

            const styles = {
                success: { bg: 'bg-green-500', icon: 'fas fa-check-circle' },
                error: { bg: 'bg-red-500', icon: 'fas fa-exclamation-triangle' },
                info: { bg: 'bg-astra-blue', icon: 'fas fa-info-circle' }
            };

            const style = styles[type] || styles.info;
            messageBox.className = `fixed top-4 right-4 z-[100] p-4 rounded-xl shadow-2xl transition-all duration-300 transform translate-x-0 opacity-100 font-bold ${style.bg} text-white`;
            messageBox.innerHTML = `<i class="${style.icon} mr-2"></i> ${message}`;

            setTimeout(() => {
                messageBox.classList.remove('translate-x-0', 'opacity-100');
                messageBox.classList.add('translate-x-full', 'opacity-0');
            }, duration);
        }

    </script>
</body>
</html>